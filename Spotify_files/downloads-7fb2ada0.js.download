import{_ as a}from"./preload-helper-be1680a6.js";import{r as y}from"./stimulus-helpers-50266f37.js";import"./index-76fb7be0.js";import{E as C}from"./ez-base-controller-29e49ea5.js";import{C as s}from"./js.cookie-c0fbedcc.js";import{g as l,i as S,a as E}from"./ajax-helpers-b23bc37b.js";import{e as L}from"./modal_helpers-630b4868.js";import{t as d,X as T,f as P,c as b,e as A,v as z,a as u}from"./helpers-a84f7625.js";import{g as h,s as I,d as k}from"./download-helpers-44904950.js";import{e as w}from"./events-1a058a8a.js";import{d as O}from"./sessions-manager-14ebd4ab.js";import{sendTrackingEvent as n,findCategoryByElement as R,trackCompleteEvent as M}from"./tracking-0dbb49c1.js";import{af as F,i as v,l as B,a4 as U,h as N,an as x,a$ as g,b0 as G,b1 as q}from"./actions-6b3b15bd.js";import{a as V}from"./index-266db5bb.js";import{e as c,a as f}from"./button-helpers-75eca042.js";import{g as p}from"./resource-show-helpers-d7044901.js";import _ from"./init-user-05a6553c.js";import{T as $}from"./turbolinks-098dba5f.js";import{F as j,b as J}from"./ez-custom-events-439a5476.js";import"./_commonjsHelpers-de833af9.js";class D extends C{constructor(){super(...arguments),this.clickProcessing=!1,this.previewImageTriggerClick=()=>{this.sendDownloadEvent(),this.resourceLicense==="editorial"?this.freeDownload():l(this.element.href)},this.proJoin=e=>{s.set("download_size_for_checkout",e.currentTarget.dataset.size)},this.proDownload=(e=null)=>{if(e&&e.preventDefault(),this.clickProcessing===!0)return;this.clickProcessing=!0,this.mainDlBtn.classList.contains("has-spinner")||c(this.mainDlBtn);const t=this.getDownloadSize(e,e==null?void 0:e.currentTarget);this.exceededDownloadLimit?this.openDownloadLimitModal():(this.triggerDownload(e,{size:t}),this.updateAllBtnDailyDownloadCount()),this.clickProcessing=!1,e!=null&&e.currentTarget.hasAttribute("data-license-selector-credit-radio-target")||h()},this.freeDownload=(e=null)=>{if(e&&e.preventDefault(),this.clickProcessing===!0)return;this.clickProcessing=!0;const t=this.getDownloadSize(e,e==null?void 0:e.currentTarget);if(I())this.element.dataset.dlAdModalPath&&this.setDownloadCookie(this.element.dataset.dlAdModalPath,t),this.updateAllBtnDailyDownloadCount("-"),this.openReturningSigninModal();else if(this.exceededDownloadLimit)this.element.dataset.dlAdModalPath&&this.setDownloadCookie(this.element.dataset.dlAdModalPath,t),this.openDownloadLimitModal();else if(this.element.dataset.dlAdModalPath){if(this.upsellExperience)d(j);else if(this.upsellPopupIsOpen&&d(J),this.showDownloadAdPopup(),this.element.getAttribute("data-license-type")!=="editorial"&&this.showFreeAttributionSlidedown(),this.element.hasAttribute("data-download-option")&&(this.mainDlBtn.classList.contains("has-spinner")||c(this.mainDlBtn)),t!=="original"){const o=this.getDownloadFileUrl(e);this.processDlSize({url:o,size:t})}}else this.triggerDownload(e,{size:t}),this.element.getAttribute("data-license-type")!=="editorial"&&T()&&this.showFreeAttributionSlidedown(),document.querySelector(".is-logged-in")&&P("customer_feedback")&&h();this.clickProcessing=!1,this.upsellPopupIsOpen||this.updateAllBtnDailyDownloadCount()},this.triggerDownload=(e,{size:t="original",reloadPage:o=!1}={})=>{var m;O(this.resourceId);const i=(m=e==null?void 0:e.detail)!=null&&m.size?e.detail.size:t,r=this.getDownloadFileUrl(e);this.mainDlBtn.classList.contains("has-spinner")||c(this.mainDlBtn),i==="original"||this.dlPopupReady?this.deliverFile({url:r,downloadSize:i,reloadPage:o}):this.processDlSize({url:r,size:i,reloadPage:o})},this.urlCheck=e=>typeof e.data.url>"u",this.pollForConvertedDlSize=async({fn:e,fnCondition:t,jobId:o,interval:i})=>{let r=await e(o);for(;t(r);)await this.waitForConvertedDlSize(i),r=await e(o);return r},this.waitForConvertedDlSize=(e=1e3)=>new Promise(t=>{setTimeout(t,e)}),this.checkSizeConversion=e=>V.get(`/api/v2/resource_conversion/${e}`),this.spendCreditAndDownload=({event:e,downloadSize:t})=>{h({onReload:!0}),this.triggerDownload(e,{size:t,reloadPage:!0}),this.creditSpent=!0}}connect(){if(this.mainDlBtn=this.element,!this.isTurbolinksPreview){const e=window.localStorage.getItem(`resource-${this.resourceId}`);e&&(this.searchData=JSON.parse(e),window.localStorage.removeItem(`resource-${this.resourceId}`)),this.flagLoaded(),this.checkDownloadCookie()}this.element.id==="pro-btn"&&this.trackLicenseTriggerEvent()}get resourceLicense(){return document.querySelector(".ez-resource-show").dataset.resourceType}updateAllBtnDailyDownloadCount(e="+"){document.querySelectorAll('[data-controller*="download-btn"]').forEach(t=>{const o=t.getAttribute("data-download-btn-daily-download-count-value")||"0";let i;e==="+"&&(i=parseInt(o,10)+1),e==="-"&&(i=parseInt(o,10)-1),t.setAttribute("data-download-btn-daily-download-count-value",`${i}`)})}getDownloadSize(e,t=null){const o="original";return e?typeof e.detail.dlSize<"u"?e.detail.dlSize:t&&t.dataset&&typeof t.dataset.size<"u"?t.dataset.size:o:o}getDownloadFileUrl(e=null){const t=this.element.getAttribute("href");return e&&typeof e.detail.downloadFileUrl<"u"?e.detail.downloadFileUrl:t}get upsellExperience(){return!(!b()||this.dailyDownloadCountValue>0||A()<=1101||this.upsellPopupIsOpen||!document.querySelector('[data-controller~="first-download-upsell-popup"]'))}get upsellPopupIsOpen(){return!!document.querySelector('[data-controller="first-download-upsell-popup"].is-active')}showFreeAttributionSlidedown(){document.querySelector('[data-controller="free-attribution-slidedown"]')&&document.querySelector('[data-controller="free-attribution-slidedown"]').remove();const e=document.querySelector('[data-controller*="resource-show-main"]').getAttribute("data-resource-id"),t=document.querySelector(".ez-page-wrapper__content");S({url:`/resources/${e}/show_free_attr_slidedown`,destElem:t,destPos:"afterbegin",successCb:()=>{d(w.show_page.reveal_free_attribution_slidedown)}})}processDlSize({url:e,size:t,reloadPage:o=!1}){this.mainDlBtn.classList.contains("has-spinner")||c(this.mainDlBtn),E(e,async i=>{const r=await this.pollForConvertedDlSize({fn:this.checkSizeConversion,fnCondition:this.urlCheck,jobId:i.data.job_id,interval:1e3});this.setS3ResponseUrlOrDeliver({url:r.data.url,size:t,reloadPage:o})},i=>{console.error(i)},{params:{size:t}})}setS3ResponseUrlOrDeliver({url:e,size:t,reloadPage:o=!1}){const i=document.body.querySelector("#download-popup-modal .download-popup");i?(this.dlPopupReady=!0,i.setAttribute("data-download-file-url",e)):this.deliverFile({url:e,downloadSize:t,reloadPage:o})}deliverFile({url:e,downloadSize:t="original",reloadPage:o=!1}){if(n({data:{action:F,label:p(),category:"Show",content_type:`Content-${this.resourceContentType}`}}),k({url:e,downloadSize:t,reloadPage:o}),this.mainDlBtn.classList.contains("has-spinner")){const i=this.mainDlBtn;t==="original"?setTimeout(()=>{f(i)},1e3):f(i)}}showDownloadAdPopup(){const e=this.element.dataset.dlAdModalPath;this.element.setAttribute("remote","true"),window.addEventListener("TriggerDownload",this.triggerDownload,{once:!0}),l(e)}setDownloadCookie(e,t){z("download_after_social_signin",e),s.set("download_size",t)}checkDownloadCookie(){const e=s.get("download_after_social_signin"),t=s.get("download_size");if(!this.exceededDownloadLimit&&e&&_.signedIn&&!new URLSearchParams(window.location.search).has("autodl_token")){if(this.element.setAttribute("remote","true"),window.addEventListener("TriggerDownload",this.triggerDownload,{once:!0}),t&&t!=="original"){const i=document.querySelector(".ez-resource-show__sidebar__download-options").dataset.downloadUrl;this.processDlSize({url:i,size:t})}l(e)}s.remove("download_after_social_signin"),s.remove("download_size")}openDownloadLimitModal(){const{dlLimitModalPath:e}=this.element.dataset;this.element.setAttribute("remote","true"),_.signedIn||n({element:this.element,data:{action:v,category:`Trigger-Download_Limit-${this.dailyDownloadCountValue}`}}),l(e)}openReturningSigninModal(){const{returningSigninModalPath:e,licenseType:t,dlAdModalPath:o,dlLimitModalPath:i}=this.element.dataset;this.element.setAttribute("remote","true"),n({element:this.element,data:{action:B,category:"Trigger-Download_Click"}}),window.addEventListener("TriggerFreeDownload",this.freeDownload,{once:!0}),l(e,null,null,null,{resource_dl_path:this.element.href,dl_size:s.get("download_size"),dl_license_type:t,dl_ad_modal_path:o,dl_limit_modal_path:i})}confirmCreditSpend(e){e.preventDefault(),e.stopImmediatePropagation();const t=e.currentTarget.dataset.size||"original";this.creditSpent?this.triggerDownload(e,{size:t}):L(e.currentTarget.getAttribute("data-confirm-text"),this.spendCreditAndDownload,["Okay","Cancel"],{callbackArgs:{event:e,downloadSize:t}})}bundleCreditSpend(e){e.preventDefault(),e.stopImmediatePropagation();const t="original";this.spendCreditAndDownload({event:e,downloadSize:t})}get isTurbolinksPreview(){return document.documentElement.hasAttribute("data-turbolinks-preview")}get resourceId(){return document.querySelector(".ez-resource-show").dataset.resourceId}get resourceType(){return document.querySelector(".ez-resource-show").dataset.resourceType}get resourceContentType(){return document.body.dataset.conversionsContentType||u()}get exceededDownloadLimit(){return this.dailyDownloadLimitValue&&this.dailyDownloadCountValue>=this.dailyDownloadLimitValue}joinProClick(e){this.sendDownloadEvent();const t=R(e.target);n({element:e.target,data:{action:U,category:t,label:"Pro"}}),M({action:N,category:t})}sendDownloadEvent(){let e={resourceId:this.resourceId,resourceType:this.resourceType};this.searchData&&(e=Object.assign(e,this.searchData)),d(w.download_btn.initial_click,e),n({element:this.element,data:{action:x,label:p(),category:"Show",content_type:`Content-${this.resourceContentType}`}})}trackFreeLicenseSelectorTrigger(e){n({element:e.currentTarget,data:{action:g,category:"Trigger-Download_Click",label:p(),content_type:`Content-${this.resourceContentType}`}})}trackLicenseTriggerEvent(e){n({element:this.element,data:{category:"Trigger-License_Toggle",action:g,label:"Free",content_type:`${u()}`}})}trackLicenseCompleteEvent(e){n({element:this.element,data:{category:"Trigger-License_Toggle",action:G,label:`License-${this.element.dataset.licenseType}`,content_type:`${u()}`}})}sendDownloadEventAndRedirect(e){e.preventDefault(),this.sendDownloadEvent(),$.visit(this.element.href)}sendCustomizeEvent(){n({element:this.element,data:{action:q}})}}D.values={dailyDownloadCount:Number,dailyDownloadLimit:Number};y([["download-btn",D],["returning-signin",a(()=>import("./returning-signin-controller-e659c210.js"),[])],["download-btn-pricing",a(()=>import("./download-btn-pricing-controller-924fbdde.js"),[])],["free-attribution-slidedown",a(()=>import("./free-attribution-slidedown-controller-947ac80c.js"),[])],["post-purchase-banner",a(()=>import("./post-purchase-banner-controller-d36b6562.js"),[])],["first-download-upsell-popup",a(()=>import("./first-download-upsell-popup-controller-54db4c76.js"),[])],["download-popup",a(()=>import("./download-popup-controller-c4d7ac6f.js"),[])],["daily-limit-join-pro-modal",a(()=>import("./daily-limit-join-pro-modal-controller-251595ef.js"),[])],["free-trial-daily-limit-modal",a(()=>import("./free-trial-daily-limit-modal-controller-3ae8a19b.js"),[])]]);
